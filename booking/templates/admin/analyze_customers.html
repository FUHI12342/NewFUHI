{% extends "admin/base_site.html" %}
{% load i18n %}
{% load custom_admin %}

{% block title %}予約情報分析{% endblock %}
{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-3">
            {% include "custom_sidebar.html" %}
        </div>
        <div class="col-md-9">
            <div class="main-content">
                <h1>顧客情報分析</h1>

                <div class="tab">
                    <button class="tablinks active" onclick="openTab(event, 'staff')">スタッフ別予約数</button>
                    <button class="tablinks" onclick="openTab(event, 'store')">店舗別予約数</button>
                    <button class="tablinks" onclick="openTab(event, 'hourly')">時間別予約数</button>
                </div>

                <div id="staff" class="tabcontent" style="display: block;">
                    <h2>スタッフ別予約数</h2>
                    <canvas id="staffChart" width="1932" height="966" style="display: block; box-sizing: border-box; height: 483px; width: 966px;"></canvas>
                </div>

                <div id="store" class="tabcontent" style="display: none;">
                    <h2>店舗別予約数</h2>
                    <canvas id="storeChart" width="1932" height="966" style="display: block; box-sizing: border-box; height: 483px; width: 966px;"></canvas>
                </div>

                <div id="hourly" class="tabcontent" style="display: none;">
                    <h2>時間別予約数</h2>
                    <canvas id="hourlyChart" width="1932" height="966" style="display: block; box-sizing: border-box; height: 483px; width: 966px;"></canvas>
                </div>

                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                    const staffData = JSON.parse('{{ staff_reservations|escapejs }}');
                    const storeData = JSON.parse('{{ store_reservations|escapejs }}');
                    const hourlyData = JSON.parse('{{ hourly_reservations|escapejs }}');
                    
                    const staffCtx = document.getElementById('staffChart').getContext('2d');
                    new Chart(staffCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(staffData),
                            datasets: [{
                                label: '予約数',
                                data: Object.values(staffData),
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            maintainAspectRatio: true,
                            responsive: true
                        }
                    });
                    
                    const storeCtx = document.getElementById('storeChart').getContext('2d');
                    new Chart(storeCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(storeData),
                            datasets: [{
                                label: '予約数',
                                data: Object.values(storeData),
                                backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                borderColor: 'rgba(153, 102, 255, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            maintainAspectRatio: true,
                            responsive: true
                        }
                    });
                    
                    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
                    new Chart(hourlyCtx, {
                        type: 'line',
                        data: {
                            labels: Object.keys(hourlyData),
                            datasets: [{
                                label: '予約数',
                                data: Object.values(hourlyData),
                                backgroundColor: 'rgba(255, 159, 64, 0.2)',
                                borderColor: 'rgba(255, 159, 64, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            maintainAspectRatio: true,
                            responsive: true
                        }
                    });

                function openTab(evt, tabName) {
                    var i, tabcontent, tablinks;
                    tabcontent = document.getElementsByClassName("tabcontent");
                    for (i = 0; i < tabcontent.length; i++) {
                        tabcontent[i].style.display = "none";
                    }
                    tablinks = document.getElementsByClassName("tablinks");
                    for (i = 0; i < tablinks.length; i++) {
                        tablinks[i].className = tablinks[i].className.replace(" active", "");
                    }
                    document.getElementById(tabName).style.display = "block";
                    evt.currentTarget.className += " active";
                }

                // デフォルトで最初のタブを開く
                document.addEventListener('DOMContentLoaded', (event) => {                    document.getElementsByClassName('tablinks')[0].click();
                });
            </script>

            <style>
                .container {
                    display: flex;
                }
                .col-md-3 {
                    flex: 0 0 25%;
                    max-width: 25%;
                }
                .col-md-9 {
                    flex: 0 0 75%;
                    max-width: 75%;
                }
                .main-content {
                    margin-left: 0;
                }
                .row {
                    display: flex;
                    width: 100%;
                }
                .tab {
                    overflow: hidden;
                    border-bottom: 1px solid #ccc;
                }

                .tab button {
                    background-color: inherit;
                    border: none;
                    outline: none;
                    cursor: pointer;
                    padding: 14px 16px;
                    transition: 0.3s;
                }

                .tab button:hover {
                    background-color: #ddd;
                }

                .tab button.active {
                    background-color: #ccc;
                }

                .tabcontent {
                    display: none;
                    padding: 6px 12px;
                    border-top: none;
                }

                canvas {
                    width: 50% !important;
                    height: 50% !important;
                }
            </style>
        </div>
    </div>
</div>
{% endblock %}