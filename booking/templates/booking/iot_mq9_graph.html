{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .mq9-chart-wrap {
      max-width: 960px;
      margin: 1.5rem auto 2rem;
    }
    .mq9-chart-wrap-inner {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 7;
    }
    .mq9-meta {
      font-size: 0.9rem;
      color: #ccc;
      margin-bottom: 0.5rem;
    }
    table.mq9-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.85rem;
    }
    table.mq9-table th,
    table.mq9-table td {
      border: 1px solid #444;
      padding: 0.3rem 0.5rem;
      white-space: nowrap;
    }
    table.mq9-table th {
      background: #222;
    }
  </style>
{% endblock %}

{% block content %}
<div id="content-main">
  <h1>{% trans "センサーモニタ" %}</h1>

  <p class="mq9-meta">
    {% trans "デバイス" %}: {{ device_external_id|default:"すべて" }} /
    {% trans "表示件数" %}: {{ labels|length }} {% trans "件" %}
  </p>

  <form method="get" style="margin-bottom: 1rem;">
    <label for="device">{% trans "デバイスID" %}:</label>
    <input type="text"
           id="device"
           name="device"
           value="{{ device_external_id|default_if_none:'' }}"
           style="min-width: 120px;">
    <button type="submit" class="button">{% trans "更新" %}</button>
  </form>

  <div class="mq9-chart-wrap">
    <div class="mq9-chart-wrap-inner">
      <canvas id="mq9Chart"></canvas>
    </div>
  </div>

  <h2>{% trans "ライブデータ" %}</h2>
  <table class="mq9-table">
    <thead>
      <tr>
        <th>{% trans "時刻" %}</th>
        <th>{% trans "MQ-9 値" %}</th>
      </tr>
    </thead>
    <tbody>
      {% for ts, val in labels_values %}
        <tr>
          <td>{{ ts }}</td>
          <td>{{ val }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="2">{% trans "データがありません。" %}</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    (function () {
      const labels = JSON.parse('{{ labels_json|escapejs }}');
      const values = JSON.parse('{{ values_json|escapejs }}');

      const ctx = document.getElementById('mq9Chart').getContext('2d');

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'MQ-9 value',
            data: values,
            borderWidth: 1,
            pointRadius: 0,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          scales: {
            x: {
              ticks: {
                maxTicksLimit: 8,
                autoSkip: true
              }
            },
            y: {
              beginAtZero: true
            }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    })();
  </script>
</div>
{% endblock %}
