{% extends 'booking/base.html' %}
{% load i18n %}

{% block title %}{% trans "シフト希望入力" %} | {{ block.super }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <h1 class="text-2xl font-bold text-salon-dark mb-2 border-b-2 border-salon-brown pb-3">
        {% trans "シフト希望入力" %}
    </h1>

    <p class="text-sm text-gray-500 mb-6">
        {{ staff.store.name }} &mdash; {{ staff.name }}
        &mdash; {{ period.year_month|date:"Y年n月" }}
    </p>

    {% if messages %}
    <div class="mb-4 space-y-2">
        {% for message in messages %}
        <div class="rounded-lg border px-4 py-3 text-sm
            {% if message.tags == 'error' %}bg-red-50 border-red-300 text-red-700
            {% elif message.tags == 'success' %}bg-green-50 border-green-300 text-green-700
            {% else %}bg-blue-50 border-blue-300 text-blue-700{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- 入力フォーム -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-8">
        <form method="post">
            {% csrf_token %}
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-semibold text-salon-dark mb-1">{% trans "日付" %}</label>
                    <input type="date" name="date" required
                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-salon-brown focus:border-salon-brown">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-salon-dark mb-1">{% trans "希望区分" %}</label>
                    <select name="preference" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        <option value="preferred">{% trans "希望" %}</option>
                        <option value="available">{% trans "出勤可能" %}</option>
                        <option value="unavailable">{% trans "出勤不可" %}</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-salon-dark mb-1">{% trans "開始時間" %}</label>
                    <select name="start_hour" required class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                        {% for h in open_hour|default:9 %}
                        <option value="{{ h }}">{{ h }}:00</option>
                        {% endfor %}
                    </select>
                    <!-- JS で動的に選択肢を生成 -->
                </div>
                <div>
                    <label class="block text-sm font-semibold text-salon-dark mb-1">{% trans "終了時間" %}</label>
                    <select name="end_hour" required class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                    </select>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold text-salon-dark mb-1">{% trans "備考" %}</label>
                <textarea name="note" rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="{% trans '任意のメモ' %}"></textarea>
            </div>
            <button type="submit"
                    class="bg-salon-brown text-white px-6 py-2.5 rounded-lg hover:bg-salon-dark transition font-medium text-sm">
                {% trans "登録する" %}
            </button>
        </form>
    </div>

    <!-- 既存の希望一覧 -->
    {% if existing %}
    <h2 class="text-lg font-bold text-salon-dark mb-4">{% trans "登録済みの希望" %}</h2>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
        <table class="w-full text-sm">
            <thead>
                <tr class="bg-salon-beige">
                    <th class="px-4 py-2 text-left">{% trans "日付" %}</th>
                    <th class="px-4 py-2 text-left">{% trans "時間" %}</th>
                    <th class="px-4 py-2 text-left">{% trans "希望区分" %}</th>
                    <th class="px-4 py-2 text-left">{% trans "備考" %}</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for req in existing %}
                <tr>
                    <td class="px-4 py-2">{{ req.date|date:"m/d (D)" }}</td>
                    <td class="px-4 py-2">{{ req.start_hour }}:00 - {{ req.end_hour }}:00</td>
                    <td class="px-4 py-2">
                        <span class="inline-block px-2 py-0.5 rounded text-xs
                            {% if req.preference == 'preferred' %}bg-green-100 text-green-700
                            {% elif req.preference == 'available' %}bg-blue-100 text-blue-700
                            {% else %}bg-red-100 text-red-700{% endif %}">
                            {{ req.get_preference_display }}
                        </span>
                    </td>
                    <td class="px-4 py-2 text-gray-500">{{ req.note|truncatechars:30 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <a href="{% url 'booking:staff_shift_calendar' %}" class="text-sm text-salon-brown hover:underline">
        &larr; {% trans "シフト管理に戻る" %}
    </a>
</div>

<script>
// 動的に開始/終了時間の選択肢を生成
const openHour = {{ open_hour }};
const closeHour = {{ close_hour }};
const startSelect = document.querySelector('select[name="start_hour"]');
const endSelect = document.querySelector('select[name="end_hour"]');

// Clear existing options
startSelect.innerHTML = '';
endSelect.innerHTML = '';

for (let h = openHour; h < closeHour; h++) {
    const opt = document.createElement('option');
    opt.value = h;
    opt.textContent = h + ':00';
    startSelect.appendChild(opt);
}

function updateEndOptions() {
    const startVal = parseInt(startSelect.value);
    endSelect.innerHTML = '';
    for (let h = startVal + 1; h <= closeHour; h++) {
        const opt = document.createElement('option');
        opt.value = h;
        opt.textContent = h + ':00';
        endSelect.appendChild(opt);
    }
}

startSelect.addEventListener('change', updateEndOptions);
updateEndOptions();
</script>
{% endblock %}
