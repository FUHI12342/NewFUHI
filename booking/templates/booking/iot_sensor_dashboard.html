{% extends "booking/base.html" %}
{% load i18n %}

{% block extra_css %}
<style>
  /* Override the base template's white background for this page */
  .iot-dashboard {
    background-color: #111827;
    color: #fff;
    margin: -1.5rem -1rem;
    padding: 1.5rem 1rem;
    min-height: 80vh;
  }
  .sensor-card {
    background-color: #1f2937;
    border: 1px solid #374151;
    border-radius: 0.75rem;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .sensor-card-header {
    padding: 1rem 1.25rem 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: baseline;
  }
  .sensor-card-body {
    padding: 0 1rem 1rem;
    flex: 1;
    position: relative;
    min-height: 220px;
  }
  .sensor-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .sensor-value {
    font-size: 2rem;
    font-weight: 700;
    line-height: 1;
  }
  .sensor-value.mq9    { color: #f97316; }
  .sensor-value.light   { color: #facc15; }
  .sensor-value.sound   { color: #34d399; }
  .sensor-value.pir     { color: #60a5fa; }

  .control-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: 1.25rem;
  }
  .control-bar select {
    background-color: #1f2937;
    color: #fff;
    border: 1px solid #4b5563;
    border-radius: 0.5rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    outline: none;
    min-width: 180px;
  }
  .control-bar select:focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 2px rgba(99,102,241,0.3);
  }
  .range-btn {
    padding: 0.4rem 0.9rem;
    font-size: 0.8rem;
    font-weight: 600;
    border-radius: 0.375rem;
    border: 1px solid #4b5563;
    background: transparent;
    color: #d1d5db;
    cursor: pointer;
    transition: all 0.15s;
  }
  .range-btn:hover {
    background-color: #374151;
  }
  .range-btn.active {
    background-color: #4f46e5;
    border-color: #4f46e5;
    color: #fff;
  }
  .status-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #22c55e;
    margin-right: 0.4rem;
    animation: pulse-dot 2s ease-in-out infinite;
  }
  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
</style>
{% endblock %}

{% block content %}
<div class="iot-dashboard">

  <!-- Page Title -->
  <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
    <h1 class="text-xl font-bold text-white flex items-center">
      <span class="status-dot"></span>
      {% trans "IoT Sensor Dashboard" %}
    </h1>
    <span id="last-updated" class="text-xs text-gray-500"></span>
  </div>

  <!-- Controls: Device Selector + Time Range -->
  <div class="control-bar">
    <select id="device-selector" aria-label="{% trans 'Select Device' %}">
      <option value="">{% trans "Loading devices..." %}</option>
    </select>
    <div class="flex gap-1">
      <button class="range-btn active" data-range="1h">1h</button>
      <button class="range-btn" data-range="6h">6h</button>
      <button class="range-btn" data-range="24h">24h</button>
      <button class="range-btn" data-range="7d">7d</button>
    </div>
  </div>

  <!-- 2x2 Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

    <!-- MQ-9 Gas -->
    <div class="sensor-card">
      <div class="sensor-card-header">
        <span class="sensor-name">{% trans "MQ-9 Gas" %}</span>
        <span class="sensor-value mq9" id="val-mq9">--</span>
      </div>
      <div class="sensor-card-body">
        <canvas id="chart-mq9"></canvas>
      </div>
    </div>

    <!-- Light -->
    <div class="sensor-card">
      <div class="sensor-card-header">
        <span class="sensor-name">{% trans "Light" %}</span>
        <span class="sensor-value light" id="val-light">--</span>
      </div>
      <div class="sensor-card-body">
        <canvas id="chart-light"></canvas>
      </div>
    </div>

    <!-- Sound -->
    <div class="sensor-card">
      <div class="sensor-card-header">
        <span class="sensor-name">{% trans "Sound" %}</span>
        <span class="sensor-value sound" id="val-sound">--</span>
      </div>
      <div class="sensor-card-body">
        <canvas id="chart-sound"></canvas>
      </div>
    </div>

    <!-- PIR Motion -->
    <div class="sensor-card">
      <div class="sensor-card-header">
        <span class="sensor-name">{% trans "PIR Motion" %}</span>
        <span class="sensor-value pir" id="val-pir">--</span>
      </div>
      <div class="sensor-card-body">
        <canvas id="chart-pir"></canvas>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
(function() {
  'use strict';

  // ── State ──────────────────────────────────────────────
  let currentRange  = '1h';
  let currentDevice = '';
  let pollTimer     = null;

  // ── DOM refs ───────────────────────────────────────────
  const deviceSelect = document.getElementById('device-selector');
  const rangeBtns    = document.querySelectorAll('.range-btn');
  const lastUpdEl    = document.getElementById('last-updated');

  // ── Colour palettes ────────────────────────────────────
  const palette = {
    mq9:   { border: '#f97316', bg: 'rgba(249,115,22,0.25)' },
    light: { border: '#facc15', bg: 'rgba(250,204,21,0.20)' },
    sound: { border: '#34d399', bg: 'rgba(52,211,153,0.20)' },
    pir:   { border: '#60a5fa', bg: 'rgba(96,165,250,0.35)' }
  };

  // ── Helper: create gradient fill ───────────────────────
  function makeGradient(ctx, color) {
    const g = ctx.createLinearGradient(0, 0, 0, ctx.canvas.clientHeight);
    g.addColorStop(0, color);
    g.addColorStop(1, 'rgba(0,0,0,0)');
    return g;
  }

  // ── Chart factory (line) ───────────────────────────────
  function createLineChart(canvasId, colorKey) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    return new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          data: [],
          borderColor: palette[colorKey].border,
          backgroundColor: makeGradient(ctx, palette[colorKey].bg),
          borderWidth: 2,
          pointRadius: 0,
          pointHitRadius: 8,
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 600,
          easing: 'easeInOutQuart'
        },
        interaction: {
          intersect: false,
          mode: 'index'
        },
        scales: {
          x: {
            ticks: { color: '#6b7280', maxTicksLimit: 8, autoSkip: true, maxRotation: 0 },
            grid:  { color: 'rgba(75,85,99,0.3)' }
          },
          y: {
            beginAtZero: true,
            ticks: { color: '#6b7280' },
            grid:  { color: 'rgba(75,85,99,0.3)' }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1f2937',
            titleColor: '#d1d5db',
            bodyColor: '#f9fafb',
            borderColor: '#374151',
            borderWidth: 1
          }
        }
      }
    });
  }

  // ── Chart factory (bar for PIR) ────────────────────────
  function createBarChart(canvasId) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    return new Chart(ctx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          data: [],
          backgroundColor: palette.pir.bg,
          borderColor: palette.pir.border,
          borderWidth: 1,
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 600,
          easing: 'easeInOutQuart'
        },
        scales: {
          x: {
            ticks: { color: '#6b7280', maxTicksLimit: 12, autoSkip: true, maxRotation: 0 },
            grid:  { color: 'rgba(75,85,99,0.3)' }
          },
          y: {
            beginAtZero: true,
            ticks: { color: '#6b7280', stepSize: 1 },
            grid:  { color: 'rgba(75,85,99,0.3)' }
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: '#1f2937',
            titleColor: '#d1d5db',
            bodyColor: '#f9fafb',
            borderColor: '#374151',
            borderWidth: 1,
            callbacks: {
              label: function(ctx) { return ctx.parsed.y + ' events'; }
            }
          }
        }
      }
    });
  }

  // ── Instantiate charts ─────────────────────────────────
  const charts = {
    mq9:   createLineChart('chart-mq9',   'mq9'),
    light: createLineChart('chart-light',  'light'),
    sound: createLineChart('chart-sound',  'sound'),
    pir:   createBarChart('chart-pir')
  };

  // ── Update a line chart with new data ──────────────────
  function updateLineChart(chart, labels, values, colorKey) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    // Refresh gradient in case canvas resized
    const ctx = chart.ctx;
    chart.data.datasets[0].backgroundColor = makeGradient(ctx, palette[colorKey].bg);
    chart.update('none');  // skip full animation for smooth polling
  }

  // ── Update bar chart (PIR) ─────────────────────────────
  function updateBarChart(chart, labels, counts) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = counts;
    chart.update('none');
  }

  // ── Fetch helpers ──────────────────────────────────────
  function sensorUrl(sensor) {
    let url = '/api/iot/sensors/data/?sensor=' + encodeURIComponent(sensor)
            + '&range=' + encodeURIComponent(currentRange);
    if (currentDevice) url += '&device_id=' + encodeURIComponent(currentDevice);
    return url;
  }

  function pirUrl() {
    let url = '/api/iot/sensors/pir-events/?range=' + encodeURIComponent(currentRange);
    if (currentDevice) url += '&device_id=' + encodeURIComponent(currentDevice);
    return url;
  }

  function fetchJSON(url) {
    return fetch(url, {
      credentials: 'same-origin',
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    }).then(function(r) {
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return r.json();
    });
  }

  // ── Fetch & render all sensors ─────────────────────────
  function refreshAll() {
    // MQ-9
    fetchJSON(sensorUrl('mq9')).then(function(d) {
      updateLineChart(charts.mq9, d.labels, d.values, 'mq9');
      var latest = d.values.length ? d.values[d.values.length - 1] : '--';
      document.getElementById('val-mq9').textContent = latest;
    }).catch(function() {
      document.getElementById('val-mq9').textContent = '--';
    });

    // Light
    fetchJSON(sensorUrl('light')).then(function(d) {
      updateLineChart(charts.light, d.labels, d.values, 'light');
      var latest = d.values.length ? d.values[d.values.length - 1] : '--';
      document.getElementById('val-light').textContent = latest;
    }).catch(function() {
      document.getElementById('val-light').textContent = '--';
    });

    // Sound
    fetchJSON(sensorUrl('sound')).then(function(d) {
      updateLineChart(charts.sound, d.labels, d.values, 'sound');
      var latest = d.values.length ? d.values[d.values.length - 1] : '--';
      document.getElementById('val-sound').textContent = latest;
    }).catch(function() {
      document.getElementById('val-sound').textContent = '--';
    });

    // PIR Motion
    fetchJSON(pirUrl()).then(function(d) {
      updateBarChart(charts.pir, d.labels, d.counts);
      var total = d.counts.reduce(function(a, b) { return a + b; }, 0);
      document.getElementById('val-pir').textContent = total + ' events';
    }).catch(function() {
      document.getElementById('val-pir').textContent = '--';
    });

    // Timestamp
    var now = new Date();
    lastUpdEl.textContent = 'Last updated: ' + now.toLocaleTimeString();
  }

  // ── Load device list ───────────────────────────────────
  function loadDevices() {
    fetchJSON('/api/iot/sensors/data/?list_devices=1').then(function(d) {
      var devices = d.devices || d || [];
      deviceSelect.innerHTML = '';

      var allOpt = document.createElement('option');
      allOpt.value = '';
      allOpt.textContent = 'All Devices';
      deviceSelect.appendChild(allOpt);

      if (Array.isArray(devices)) {
        devices.forEach(function(dev) {
          var opt = document.createElement('option');
          if (typeof dev === 'object') {
            opt.value = dev.id || dev.device_id || '';
            opt.textContent = dev.name || dev.device_id || dev.id || 'Device';
          } else {
            opt.value = dev;
            opt.textContent = dev;
          }
          deviceSelect.appendChild(opt);
        });
      }
    }).catch(function() {
      deviceSelect.innerHTML = '<option value="">No devices found</option>';
    });
  }

  // ── Polling control ────────────────────────────────────
  function startPolling() {
    stopPolling();
    refreshAll();
    pollTimer = setInterval(refreshAll, 10000);
  }

  function stopPolling() {
    if (pollTimer) {
      clearInterval(pollTimer);
      pollTimer = null;
    }
  }

  // ── Event listeners ────────────────────────────────────
  deviceSelect.addEventListener('change', function() {
    currentDevice = this.value;
    startPolling();
  });

  rangeBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      rangeBtns.forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      currentRange = btn.getAttribute('data-range');
      startPolling();
    });
  });

  // Pause polling when tab is hidden to save resources
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      stopPolling();
    } else {
      startPolling();
    }
  });

  // ── Init ───────────────────────────────────────────────
  loadDevices();
  startPolling();

})();
</script>
{% endblock %}
