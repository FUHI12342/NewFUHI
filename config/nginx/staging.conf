# Nginx configuration for NewFUHI staging environment
# Location: /etc/nginx/sites-available/newfuhi-staging

server {
    listen 80;
    server_name staging.newfuhi.com;
    
    # Security headers
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header X-Robots-Tag "noindex, nofollow" always;
    
    # Privacy controls - IP allowlist
    # Office network
    allow 192.168.1.0/24;
    # VPN network  
    allow 10.0.0.0/8;
    # Localhost for testing
    allow 127.0.0.1;
    # Add your IP addresses here
    # allow YOUR_IP_ADDRESS;
    deny all;
    
    # BasicAuth fallback for authorized external access
    auth_basic "Staging Environment - Authorized Access Only";
    auth_basic_user_file /etc/nginx/.htpasswd;
    
    # Robots.txt for search engine privacy
    location = /robots.txt {
        add_header Content-Type text/plain;
        return 200 "User-agent: *\nDisallow: /\n";
    }
    
    # Static files
    location /static/ {
        alias /var/www/newfuhi/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # Security headers for static files
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Robots-Tag "noindex, nofollow" always;
    }
    
    # Media files
    location /media/ {
        alias /var/www/newfuhi/media/;
        expires 30d;
        add_header Cache-Control "public";
        
        # Security headers for media files
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Robots-Tag "noindex, nofollow" always;
    }
    
    # Application proxy
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Proxy timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # Buffer settings
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }
    
    # Access and error logs
    access_log /var/log/nginx/newfuhi-staging-access.log;
    error_log /var/log/nginx/newfuhi-staging-error.log;
    
    # Rate limiting (optional)
    # limit_req zone=staging burst=20 nodelay;
}

# Rate limiting zone definition (uncomment if needed)
# http {
#     limit_req_zone $binary_remote_addr zone=staging:10m rate=10r/s;
# }