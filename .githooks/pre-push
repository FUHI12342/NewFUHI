#!/bin/bash
# Pre-push hook for NewFUHI project
# Prevents direct pushes to protected branches

set -e

protected_branches="main master"
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

echo "üîç Checking branch protection for: $current_branch"

# Check if current branch is protected
for branch in $protected_branches; do
    if [ "$current_branch" = "$branch" ]; then
        echo ""
        echo "‚ùå ERROR: Direct push to protected branch '$branch' is not allowed"
        echo ""
        echo "Protected branches require pull requests for code review."
        echo ""
        echo "To contribute to this branch:"
        echo "1. Create a feature branch: git checkout -b feature/your-feature"
        echo "2. Make your changes and commit them"
        echo "3. Push your feature branch: git push origin feature/your-feature"
        echo "4. Create a pull request on GitHub"
        echo ""
        echo "If you need to force push (DANGEROUS):"
        echo "   git push --no-verify"
        echo ""
        exit 1
    fi
done

echo "‚úÖ Branch protection check passed"

# Additional validation for staging/develop branches
if [ "$current_branch" = "develop" ] || [ "$current_branch" = "staging" ]; then
    echo "üîç Running additional checks for deployment branch..."
    
    # Check if Django check passes
    if command -v python >/dev/null 2>&1; then
        echo "Running Django system check..."
        if ! python manage.py check >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  WARNING: Django system check failed"
            echo "   This may cause deployment issues"
            echo "   Run 'python manage.py check' to see details"
        else
            echo "‚úÖ Django system check passed"
        fi
    fi
fi

echo "‚úÖ Pre-push validation completed"
exit 0