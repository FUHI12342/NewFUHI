{% extends "admin/change_form.html" %}
{% load i18n %}

{% block extrastyle %}
{{ block.super }}
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css">
<style>
/* Tailwind-inspired change form styles */

/* Form container */
#content-main form {
    background: transparent;
}

/* Fieldsets */
fieldset.module {
    background: #fff;
    border: 1px solid var(--gray-200, #e5e7eb) !important;
    border-radius: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    margin-bottom: 16px;
    overflow: visible;
}
fieldset.module > h2 {
    border-radius: 12px 12px 0 0;
    overflow: hidden;
}
fieldset.module h2 {
    background: var(--gray-100, #f3f4f6) !important;
    color: var(--gray-700, #374151) !important;
    padding: 10px 16px !important;
    font-size: 13px !important;
    font-weight: 600;
    border-bottom: 1px solid var(--gray-200, #e5e7eb);
}

/* Form rows */
.form-row {
    padding: 10px 16px !important;
    border-bottom: 1px solid var(--gray-100, #f3f4f6);
}
.form-row:last-child {
    border-bottom: none;
}
.form-row label {
    font-size: 13px;
    font-weight: 500;
    color: var(--gray-700, #374151);
}

/* Inputs */
input[type="text"],
input[type="number"],
input[type="email"],
input[type="url"],
input[type="password"],
input[type="date"],
input[type="time"],
input[type="datetime-local"],
textarea,
select {
    padding: 8px 12px !important;
    border: 1px solid var(--gray-300, #d1d5db) !important;
    border-radius: 8px !important;
    font-size: 13px !important;
    line-height: 1.4 !important;
    min-height: 38px;
    transition: border-color 0.15s, box-shadow 0.15s;
    background: #fff !important;
    width: auto;
    max-width: 100%;
}
input[type="text"]:focus,
input[type="number"]:focus,
input[type="email"]:focus,
input[type="url"]:focus,
input[type="password"]:focus,
input[type="date"]:focus,
input[type="time"]:focus,
input[type="datetime-local"]:focus,
textarea:focus,
select:focus {
    border-color: var(--brand-primary, #465fff) !important;
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(70, 95, 255, 0.1) !important;
}

/* Checkbox / Radio */
input[type="checkbox"],
input[type="radio"] {
    accent-color: var(--brand-primary, #465fff);
}

/* Submit row */
.submit-row {
    background: var(--gray-50, #f9fafb) !important;
    border: 1px solid var(--gray-200, #e5e7eb) !important;
    border-radius: 12px !important;
    padding: 12px 16px !important;
    margin-top: 16px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.submit-row input[type="submit"] {
    border-radius: 8px !important;
    padding: 8px 20px !important;
    font-size: 13px !important;
    font-weight: 500;
}
.submit-row .deletelink-box a {
    color: var(--error, #f04438) !important;
    font-size: 13px;
    padding: 8px 16px;
    border: 1px solid var(--error, #f04438);
    border-radius: 8px;
    text-decoration: none;
    transition: background 0.15s;
}
.submit-row .deletelink-box a:hover {
    background: rgba(240, 68, 56, 0.05);
}

/* Inline groups */
.inline-group {
    background: #fff;
    border: 1px solid var(--gray-200, #e5e7eb);
    border-radius: 12px;
    overflow: visible;
    margin-bottom: 16px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
}
.inline-group > h2 {
    border-radius: 12px 12px 0 0;
    overflow: hidden;
}
.inline-group h2 {
    background: var(--gray-100, #f3f4f6) !important;
    color: var(--gray-700, #374151) !important;
    padding: 10px 16px !important;
    font-size: 13px !important;
    font-weight: 600;
}

/* Tabular inline table */
.inline-group table {
    border-collapse: collapse;
    width: 100%;
}
.inline-group table thead th {
    background: var(--gray-50, #f9fafb);
    border-bottom: 1px solid var(--gray-200, #e5e7eb);
    padding: 8px 12px;
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-600, #4b5563);
}
.inline-group table tbody td {
    padding: 8px 12px;
    font-size: 13px;
    border-bottom: 1px solid var(--gray-100, #f3f4f6);
}

/* Help text */
.help {
    font-size: 12px !important;
    color: var(--gray-400, #9ca3af) !important;
    margin-top: 4px;
}

/* Error list */
.errorlist li {
    color: var(--error, #f04438);
    font-size: 13px;
    background: rgba(240, 68, 56, 0.05);
    padding: 6px 12px;
    border-radius: 6px;
    margin-bottom: 4px;
}

/* Read-only fields */
.readonly {
    padding: 8px 0;
    font-size: 13px;
    color: var(--gray-600, #4b5563);
}

/* Related widget wrapper */
.related-widget-wrapper {
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Leaflet map widget */
.leaflet-map-widget {
    height: 250px;
    width: 100%;
    border-radius: 8px;
    margin-top: 8px;
    border: 1px solid var(--gray-200, #e5e7eb);
}

/* Flatpickr overrides */
.flatpickr-calendar {
    border-radius: 12px !important;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15) !important;
}
</style>
{% endblock %}

{% block content %}
{{ block.super }}

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== Flatpickr: Date fields =====
    var dateFields = document.querySelectorAll('input.vDateField, input[type="date"]');
    dateFields.forEach(function(el) {
        flatpickr(el, {
            locale: 'ja',
            dateFormat: 'Y-m-d',
            allowInput: true,
        });
    });

    // ===== Flatpickr: Time fields =====
    var timeFields = document.querySelectorAll('input.vTimeField, input[type="time"]');
    timeFields.forEach(function(el) {
        flatpickr(el, {
            locale: 'ja',
            enableTime: true,
            noCalendar: true,
            dateFormat: 'H:i',
            time_24hr: true,
            allowInput: true,
        });
    });

    // ===== Leaflet: Address fields =====
    var addressInputs = document.querySelectorAll('input[name*="address"]');
    addressInputs.forEach(function(input) {
        // Skip if already has a map
        if (input.dataset.mapAttached) return;
        input.dataset.mapAttached = 'true';

        // Create map container
        var mapDiv = document.createElement('div');
        mapDiv.className = 'leaflet-map-widget';
        mapDiv.id = 'map-' + input.name;
        input.parentNode.insertBefore(mapDiv, input.nextSibling);

        // Initialize Leaflet map (default: Tokyo)
        var map = L.map(mapDiv.id).setView([35.6895, 139.6917], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19,
        }).addTo(map);

        var marker = L.marker([35.6895, 139.6917], { draggable: true }).addTo(map);

        // Reverse geocode on marker drag
        function reverseGeocode(lat, lng) {
            fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lng + '&accept-language=ja')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.display_name) {
                        input.value = data.display_name;
                    }
                })
                .catch(function() {});
        }

        marker.on('dragend', function(e) {
            var pos = e.target.getLatLng();
            reverseGeocode(pos.lat, pos.lng);
        });

        map.on('click', function(e) {
            marker.setLatLng(e.latlng);
            reverseGeocode(e.latlng.lat, e.latlng.lng);
        });

        // If address field has a value, geocode it to set map position
        if (input.value.trim()) {
            fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(input.value) + '&limit=1&accept-language=ja')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.length > 0) {
                        var lat = parseFloat(data[0].lat);
                        var lon = parseFloat(data[0].lon);
                        map.setView([lat, lon], 16);
                        marker.setLatLng([lat, lon]);
                    }
                })
                .catch(function() {});
        }

        // Fix map rendering when container becomes visible
        setTimeout(function() { map.invalidateSize(); }, 200);
    });
});
</script>
{% endblock %}
