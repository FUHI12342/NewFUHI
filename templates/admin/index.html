{% extends "admin/index.html" %}
{% load i18n %}

{% block content %}
{% if user.is_superuser or user.is_staff %}

<!-- ===== Dashboard Top Bar (横一列) ===== -->
<div class="admin-topbar">
    {% if is_developer_or_superuser %}
    <a href="{% url 'admin_debug_panel' %}" class="admin-topbar__item admin-topbar__item--debug">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/>
        </svg>
        {% trans "デバッグパネル" %}
    </a>
    {% endif %}
    <a href="{% url 'admin_sales_dashboard' %}" class="admin-topbar__item admin-topbar__item--sales">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
        </svg>
        {% trans "売り上げダッシュボード" %}
    </a>
    <a href="{% url 'admin_iot_mq9' %}" class="admin-topbar__item admin-topbar__item--sensor">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
        </svg>
        {% trans "センサーモニタ" %}
    </a>
</div>

{% endif %}

{{ block.super }}

<!-- ===== 3列グリッド + 最近行った操作 右端ドロワー ===== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // === 1. App list を 3列グリッドにする ===
    var contentMain = document.getElementById('content-main');
    if (contentMain) {
        contentMain.classList.add('admin-app-grid');
    }

    // === 2. 最近行った操作 → 右端スライドドロワー ===
    var recentModule = document.getElementById('recent-actions-module');
    if (!recentModule) return;

    // 元の #content-related を非表示
    var contentRelated = document.getElementById('content-related');
    if (contentRelated) {
        contentRelated.style.display = 'none';
    }

    // ドロワー構造を作成
    var drawer = document.createElement('div');
    drawer.className = 'admin-recent-drawer';

    // タブ（縦書きラベル、ドロワー左端に配置）
    var tab = document.createElement('div');
    tab.className = 'admin-recent-tab';
    tab.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>' +
        '{% trans "最近行った操作" %}';

    // パネル（コンテンツエリア）
    var panel = document.createElement('div');
    panel.className = 'admin-recent-panel';

    var panelHeader = document.createElement('div');
    panelHeader.className = 'admin-recent-panel-header';
    panelHeader.textContent = '{% trans "最近行った操作" %}';

    var panelBody = document.createElement('div');
    panelBody.className = 'admin-recent-panel-body';

    // 既存のアクションリストをパネルに移動
    var actionList = recentModule.querySelector('ul');
    if (actionList) {
        panelBody.appendChild(actionList);
    } else {
        Array.from(recentModule.children).forEach(function(child) {
            if (child.tagName !== 'H2') {
                panelBody.appendChild(child.cloneNode(true));
            }
        });
    }

    panel.appendChild(panelHeader);
    panel.appendChild(panelBody);
    drawer.appendChild(tab);
    drawer.appendChild(panel);
    document.body.appendChild(drawer);

    // 折りたたみ状態を復元（デフォルトは折りたたみ）
    var isCollapsed = localStorage.getItem('admin_recent_drawer') !== 'open';
    if (isCollapsed) {
        drawer.classList.add('collapsed');
    }

    // タブクリックでトグル
    tab.addEventListener('click', function() {
        drawer.classList.toggle('collapsed');
        localStorage.setItem('admin_recent_drawer',
            drawer.classList.contains('collapsed') ? 'collapsed' : 'open');
    });
});
</script>
{% endblock %}
